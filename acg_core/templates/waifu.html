{% load static %}

<div class="flex flex-col h-full">
    <div class="space-y-4 mb-auto">
        <div class="text-center mb-6 border-b border-pink-50 pb-4">
            <h3 class="acg-font text-xl text-pink-600">控制面板</h3>
            <p class="text-[10px] text-gray-400 tracking-widest uppercase font-bold italic">Sakura Station</p>
        </div>

        <div class="grid grid-cols-2 gap-3">
            <button class="glass-card p-3 text-xs flex flex-col items-center hover:bg-pink-500 hover:text-white transition group border-none shadow-sm">
                <i class="fa-solid fa-wand-sparkles mb-2 text-pink-500 group-hover:text-white"></i>查看说明
            </button>
            <button class="glass-card p-3 text-xs flex flex-col items-center hover:bg-pink-500 hover:text-white transition group border-none shadow-sm">
                <i class="fa-solid fa-face-smile-beam mb-2 text-pink-500 group-hover:text-white"></i>助手设置
            </button>
        </div>

        <div class="glass-card p-6 mt-2 space-y-4 bg-white/60 border-none shadow-inner">
            <p class="text-[17px] text-pink-500 font-bold acg-font tracking-widest">和小柚聊聊天吧</p>
            <div class="relative">
                <input type="text" id="chat-input" placeholder="输入你想说的话..."
                       class="w-full bg-white/80 border border-pink-100 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-pink-300 transition shadow-sm">
                <button id="chat-send" class="absolute right-3 top-3 text-pink-400 hover:text-pink-600 transition text-lg">
                    <i class="fa-solid fa-paper-plane"></i>
                </button>
            </div>
        </div>

        <div id="user-bubble-container" class="glass-card p-4 mt-2 bg-white/60 border-none shadow-inner hidden">
            <div class="flex justify-between text-[10px] font-bold mb-1 text-pink-400">
                <span>MASTER SAYS:</span>
            </div>
            <div id="user-last-question" class="text-xs text-gray-500 italic leading-relaxed text-gray-600"></div>
        </div>
    </div>

    <div class="flex flex-col items-center mt-auto waifu-visual-footer">
        <div id="waifu-tips" class="glass-card p-4 mb-3 w-full text-sm border-l-4 border-pink-500 shadow-md leading-relaxed text-gray-700 min-h-[65px]">
            </div>
        <div class="cursor-pointer group waifu-container" id="waifu-container">
            <img id="waifu-img" src="{% static 'images/waifu.png' %}" class="waifu-img-obj waifu-floating drop-shadow-2xl group-hover:scale-105 transition-transform duration-300">
        </div>
    </div>
</div>

<script>
    let currentAbortController = null;
    const waifuElement = document.getElementById('waifu-img');
    const tipsElement = document.getElementById('waifu-tips');
    const chatInput = document.getElementById('chat-input');
    const chatSend = document.getElementById('chat-send');
    const userBubble = document.getElementById('user-bubble-container');
    const userText = document.getElementById('user-last-question');

    // 初始状态文字
    tipsElement.innerHTML = "......";

    const emotions = {
        'normal': "{% static 'images/waifu.png' %}",
        '1': "{% static 'images/waifu_happy.png' %}",
        '2': "{% static 'images/waifu_shy.png' %}",
        '3': "{% static 'images/waifu_sad.png' %}",
        '4': "{% static 'images/waifu_sweat.png' %}",
        '5': "{% static 'images/waifu_serious.png' %}",
        '6': "{% static 'images/waifu_fortunate.png' %}",
        '7': "{% static 'images/waifu_dizzy.png' %}",
    };

    let isThinking = false;
    let emotionTimer = null;

    async function askXiaoYou(type, content = '') {
        // 如果正在思考同一个请求则跳过，但如果是不同类型的请求（如页面跳转）则中断之前的
        if (isThinking && type === 'GENERAL') return;

        if (currentAbortController) {
            currentAbortController.abort();
        }
        currentAbortController = new AbortController();
        const signal = currentAbortController.signal;

        // UI 反馈
        if (type === 'CHAT' && content.trim() !== '') {
            userText.innerText = content;
            userBubble.classList.remove('hidden');
        } else if (type === 'CLICK') {
            userText.innerText = "(触碰了小柚)";
            userBubble.classList.remove('hidden');
            const clickPrompts = [
                "主人温柔地摸了摸你的头，你感到脸红心跳～",
                "主人在摸你的头呢，快撒个娇吧～",
                "主人在摸你的头，超级喜欢主人！",
                "主人拍了一下你的头，你感到晕乎乎的",
            ];
            content = clickPrompts[Math.floor(Math.random() * clickPrompts.length)];
        } else {
            userBubble.classList.add('hidden');
        }

        isThinking = true;
        tipsElement.innerHTML = "......"; // 确保每次请求开始都显示加载
        waifuElement.classList.add('animate__animated', 'animate__pulse');

        try {
            const response = await fetch("{% url 'kanban_chat' %}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ type: type, content: content }),
                signal: signal
            });
            const data = await response.json();

            let rawReply = data.reply;
            let emotionCode = rawReply.charAt(0);
            let displayText = rawReply.slice(1);

            waifuElement.src = emotions[emotionCode] || emotions['normal'];
            tipsElement.innerHTML = displayText;

            // 成功后标记
            sessionStorage.setItem('waifu_initialized', 'true');

            if (emotionTimer) clearTimeout(emotionTimer);
            emotionTimer = setTimeout(() => {
                if (!isThinking) waifuElement.src = emotions['normal'];
            }, 6000);

        } catch (error) {
            if (error.name === 'AbortError') {
                console.log('请求被新指令覆盖：', type);
            } else {
                console.error('API请求失败:', error);
                tipsElement.innerHTML = "4呜...小柚的信号好像断掉了...主人能再试一次吗？";
            }
        } finally {
            isThinking = false;
            waifuElement.classList.remove('animate__pulse');
        }
    }

    function handleSend() {
        const text = chatInput.value.trim();
        if (text) { askXiaoYou('CHAT', text); chatInput.value = ''; }
    }

    chatSend.onclick = handleSend;
    chatInput.onkeypress = (e) => { if(e.key === 'Enter') handleSend(); };
    document.getElementById('waifu-container').onclick = () => askXiaoYou('CLICK');

    // --- 核心修复部分 ---
    window.addEventListener('load', () => {
        const path = window.location.pathname;

        setTimeout(() => {
            // 1. 检查错误拦截位（登录/注册失败时）
            if (sessionStorage.getItem('xiaoyou_handling_error') === 'true') {
                sessionStorage.removeItem('xiaoyou_handling_error');
                return;
            }

            // 2. 路由逻辑：只要回到首页或进入登录/注册，就必须通过 askXiaoYou 向 DeepSeek 发起请求
            if (path.includes('/login/')) {
                askXiaoYou('LOGIN');
            } else if (path.includes('/register/')) {
                // 注册页逻辑通常由 register.html 里的 script 触发，这里可以留空
            } else if (path === '/' || path === '/index/') {
                // 修复：删除了 sessionStorage 的判断，确保每次返回首页都会调用 API
                askXiaoYou('GENERAL');
            }
        }, 800);
    });
</script>

<style>
    .waifu-visual-footer { transform: translateY(20px); width: 100%; }
    .waifu-container { position: relative; width: 100%; max-width: 320px; height: 380px; display: flex; align-items: flex-end; justify-content: center; }
    .waifu-img-obj { max-width: 100%; max-height: 100%; object-fit: contain; }
    .acg-font { font-family: 'ZCOOL KuaiLe', cursive; }
</style>