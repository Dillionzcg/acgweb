{% extends 'base.html' %}
{% load static %}

{% block title %}ä¸ªäººä¸­å¿ƒ{% endblock %}

{% block content %}
<style>
    /* 2*2 æ€§åˆ«é€‰æ‹©å™¨å®¹å™¨ */
    .gender-grid-container {
        display: grid;
        grid-template-cols: repeat(2, 1fr);
        gap: 12px;
        padding: 8px;
        background: rgba(255, 241, 242, 0.5);
        border-radius: 24px;
        border: 1px solid rgba(252, 231, 235, 1);
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    #gender-slider {
        position: absolute;
        background: white;
        border-radius: 16px;
        z-index: 0;
        box-shadow: 0 4px 12px rgba(244, 114, 182, 0.15), 0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.8);
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .gender-btn {
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px 8px;
        font-size: 0.875rem;
        font-weight: 700;
        color: #9ca3af;
        border-radius: 16px;
        transition: all 0.2s ease;
        cursor: pointer;
        background: transparent;
        border: none;
    }

    @media (max-width: 640px) {
        .gender-btn { padding: 12px 6px; }
    }
</style>

<div class="max-w-5xl mx-auto px-4 py-10 animate__animated animate__fadeIn">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

        <div class="lg:col-span-1">
            <div class="glass-card p-8 text-center relative border-2 border-pink-100">
                <a href="{% url 'index' %}" class="absolute top-5 left-5 w-10 h-10 flex items-center justify-center bg-pink-500 text-white rounded-full shadow-lg hover:bg-pink-600 hover:scale-110 transition-all z-10">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>

                <div class="relative w-36 h-36 mx-auto mb-6 mt-4">
                    <div id="avatar-preview-container" class="w-full h-full rounded-3xl border-4 border-white shadow-xl bg-pink-50 overflow-hidden flex items-center justify-center">
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                            <img src="{% static 'images/default_head.png' %}" class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <label for="avatar-input" class="absolute bottom-0 right-0 w-10 h-10 bg-pink-500 text-white rounded-2xl border-4 border-white flex items-center justify-center cursor-pointer hover:scale-110 transition-all shadow-lg">
                        <i class="fa-solid fa-camera-retro"></i>
                    </label>
                    <input type="file" id="avatar-input" class="hidden" accept="image/*">
                </div>

                <h2 class="text-2xl font-bold text-gray-800">{{ user.username }}</h2>
                <p id="side-bio" class="text-sm text-pink-400 mt-2 italic">â€œ {{ user.bio|default:"Masterè¿˜æ²¡å†™ç®€ä»‹å‘¢ï½" }} â€</p>

                <div class="mt-8 flex justify-center space-x-4">
                    <div class="text-center">
                        <div class="text-xl font-bold text-pink-500">233</div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest">æ”¶è—</div>
                    </div>
                    <div class="w-px h-8 bg-pink-100 self-center"></div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-pink-500">12k</div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest">äººæ°”</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="glass-card p-10">
                <div class="flex items-center justify-between mb-10">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">æ¡£æ¡ˆç¼–è¾‘</h3>
                        <p class="text-xs text-pink-300 mt-1">å®Œå–„ä½ çš„æ¬¡å…ƒé€šè¡Œè¯ä¿¡æ¯</p>
                    </div>
                    <div id="save-hint" class="opacity-0 transition-opacity bg-green-100 text-green-600 px-4 py-2 rounded-full text-xs font-bold">
                        <i class="fa-solid fa-circle-check mr-1"></i> åŒæ­¥æˆåŠŸ
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">æ¬¡å…ƒæ€§åˆ«</label>
                        <div class="relative grid grid-cols-2 gap-3 p-1.5 bg-pink-50/50 rounded-[2rem] border border-pink-100 shadow-inner">
                            <div id="gender-slider" class="absolute bg-white rounded-2xl shadow-sm transition-all duration-300 ease-out z-0" style="width: calc(50% - 0.75rem); height: calc(50% - 0.75rem);"></div>

                            <button type="button" onclick="switchGender(0, 'male')" class="gender-btn z-10"><span class="mr-2">â™‚ï¸</span>å°‘å¹´</button>
                            <button type="button" onclick="switchGender(1, 'female')" class="gender-btn z-10"><span class="mr-2">â™€ï¸</span>å°‘å¥³</button>
                            <button type="button" onclick="switchGender(2, 'cat')" class="gender-btn z-10"><span class="mr-2">ğŸ¾</span>çŒ«çŒ«</button>
                            <button type="button" onclick="switchGender(3, 'alien')" class="gender-btn z-10"><span class="mr-2">ğŸ›¸</span>å¤–æ˜Ÿç”Ÿå‘½</button>

                            <input type="hidden" id="gender-val" value="{{ user.gender|default:'female' }}">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">è¯ç”Ÿçºªå¿µæ—¥</label>
                        <div class="flex space-x-2">
                            <select id="birth-year" class="flex-1 px-3 py-3 bg-white/70 border-2 border-pink-50 rounded-2xl outline-none text-sm text-gray-600 appearance-none text-center cursor-pointer"></select>
                            <select id="birth-month" class="w-20 px-1 py-3 bg-white/70 border-2 border-pink-50 rounded-2xl outline-none text-sm text-gray-600 appearance-none text-center cursor-pointer"></select>
                            <select id="birth-day" class="w-20 px-1 py-3 bg-white/70 border-2 border-pink-50 rounded-2xl outline-none text-sm text-gray-600 appearance-none text-center cursor-pointer"></select>
                        </div>
                        <input type="hidden" id="birthday-val" value="{{ user.birthday|date:'Y-m-d' }}">
                    </div>
                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">æ‰‹æœºå· (Phone)</label>
                        <div class="relative group">
                            <i class="fa-solid fa-mobile absolute left-5 top-1/2 -translate-y-1/2 text-pink-300 transition-colors group-focus-within:text-pink-500"></i>
                            <input type="text" id="phone-val"
                                   class="w-full pl-12 pr-6 py-4 bg-white/70 border-2 border-pink-50 rounded-3xl focus:border-pink-300 outline-none transition-all"
                                   placeholder="ç»‘å®šæ‰‹æœºå·" value="{{ user.phone|default:'' }}">
                        </div>
                        <p id="phone-error" class="text-red-400 text-xs ml-4 italic hidden"></p>
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">ç”µå­é‚®ç®± (Email)</label>
                        <div class="relative group">
                            <i class="fa-solid fa-envelope absolute left-5 top-1/2 -translate-y-1/2 text-pink-300"></i>
                            <input type="email" id="email-val"
                                   class="w-full pl-12 pr-6 py-4 bg-white/70 border-2 border-pink-50 rounded-3xl focus:border-pink-300 outline-none transition-all"
                                   placeholder="ç»‘å®šé‚®ç®±" value="{{ user.email }}">
                        </div>
                        <p id="email-error" class="text-red-400 text-xs ml-4 italic hidden"></p>
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">æ¬¡å…ƒæ ¼è¨€ (Bio)</label>
                        <textarea id="bio-val" rows="3" class="w-full px-6 py-4 bg-white/70 border-2 border-pink-50 rounded-3xl focus:border-pink-300 outline-none transition-all resize-none" placeholder="å†™ç‚¹ä»€ä¹ˆè®©å¤§å®¶è®°ä½ä½ å§...">{{ user.bio }}</textarea>
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">å…´è¶£æ ‡ç­¾ (Tags)</label>
                        <div id="tag-container" class="flex flex-wrap gap-3 p-4 bg-pink-50/30 rounded-3xl border-2 border-dashed border-pink-100 min-h-[80px]">
                            {% for tag in user.tags %}
                            <div class="group px-4 py-2 bg-white text-pink-500 rounded-full text-xs font-bold border border-pink-100 shadow-sm flex items-center">
                                <span># {{ tag }}</span>
                                <button onclick="removeTag(this)" class="ml-2 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="fa-solid fa-circle-xmark"></i>
                                </button>
                            </div>
                            {% endfor %}
                            <button onclick="showTagInput()" class="px-4 py-2 bg-pink-500/10 text-pink-500 rounded-full text-xs font-bold border border-pink-200 border-dashed hover:bg-pink-500 hover:text-white transition-all">
                                <i class="fa-solid fa-plus mr-1"></i> æ–°å¢æ ‡ç­¾
                            </button>
                        </div>
                        <div id="tag-input-box" class="hidden mt-4">
                            <div class="flex space-x-2">
                                <input type="text" id="new-tag-input" class="flex-1 px-5 py-2 rounded-full border border-pink-200 outline-none" placeholder="è¾“å…¥æ ‡ç­¾å...">
                                <button onclick="addTag()" class="bg-pink-500 text-white px-6 py-2 rounded-full font-bold hover:bg-pink-600 transition-all">ç¡®è®¤</button>
                                <button onclick="hideTagInput()" class="bg-gray-100 text-gray-500 px-4 py-2 rounded-full font-bold hover:bg-gray-200 transition-all">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <button onclick="saveProfile(this)" class="w-full py-5 bg-gradient-to-r from-pink-400 to-pink-500 text-white rounded-full font-bold text-lg shadow-lg hover:scale-[1.01] active:scale-95 transition-all">
                        ç¡®è®¤åŒæ­¥åˆ°æ¬¡å…ƒæ¡£æ¡ˆ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. æ—¥æœŸé€‰æ‹©å™¨åˆå§‹åŒ–é€»è¾‘
    function initDateSelects() {
        const yearSelect = document.getElementById('birth-year');
        const monthSelect = document.getElementById('birth-month');
        const daySelect = document.getElementById('birth-day');
        const currentVal = document.getElementById('birthday-val').value;

        let dateObj = (currentVal && currentVal !== 'None') ? new Date(currentVal) : null;
        const currentYear = new Date().getFullYear();

        for (let i = currentYear; i >= 1970; i--) yearSelect.add(new Option(`${i} å¹´`, i));
        for (let i = 1; i <= 12; i++) monthSelect.add(new Option(`${i} æœˆ`, i));

        function updateDays(targetDay = null) {
            const y = yearSelect.value, m = monthSelect.value;
            const totalDays = new Date(y, m, 0).getDate();
            const lastSelected = targetDay || daySelect.value;
            daySelect.innerHTML = '';
            for (let i = 1; i <= totalDays; i++) daySelect.add(new Option(`${i} æ—¥`, i));
            if (lastSelected && lastSelected <= totalDays) daySelect.value = lastSelected;
        }

        yearSelect.onchange = () => updateDays();
        monthSelect.onchange = () => updateDays();

        if (dateObj && !isNaN(dateObj.getTime())) {
            yearSelect.value = dateObj.getFullYear();
            monthSelect.value = dateObj.getMonth() + 1;
            updateDays(dateObj.getDate());
        } else {
            updateDays(1);
        }
    }

    // 2. æ€§åˆ«åˆ‡æ¢é€»è¾‘
    function switchGender(index, value, shouldAsk = true) {
        const slider = document.getElementById('gender-slider');
        const valInput = document.getElementById('gender-val');
        const buttons = document.querySelectorAll('.gender-btn');

        valInput.value = value;
        const col = index % 2, row = Math.floor(index / 2);
        slider.style.left = `calc(${col * 50}% + 0.375rem)`;
        slider.style.top = `calc(${row * 50}% + 0.375rem)`;

        buttons.forEach((btn, i) => {
            btn.className = `gender-btn z-10 ${i === index ? 'text-pink-500 scale-105' : 'text-gray-500'}`;
        });

        if (shouldAsk) {
            const names = ["å°‘å¹´", "å°‘å¥³", "çŒ«çŒ«", "å¤–æ˜Ÿç”Ÿå‘½"];
            safeAskXiaoYou('USER_UPDATE', `æˆ‘æŠŠæ€§åˆ«æ”¹æˆ${names[index]}å•¦ï¼ï¼ˆè¯·æ¸©æŸ”å¯çˆ±åœ°è¡¨è¾¾å¯¹ä¸»äººæ€§åˆ«çš„å–œçˆ±(6)ï¼Œè‹¥æ˜¯çŒ«çŒ«è¯·è¡¨ç°å¾—éå¸¸å…´å¥‹ï¼‰`);
        }
    }

    // 3. æ ‡ç­¾ä¸å¤´åƒé€»è¾‘
    function showTagInput() { document.getElementById('tag-input-box').classList.remove('hidden'); }
    function hideTagInput() { document.getElementById('tag-input-box').classList.add('hidden'); }
    function removeTag(el) { el.parentElement.remove(); }

    function addTag() {
        const input = document.getElementById('new-tag-input');
        const tag = input.value.trim();
        if(tag) {
            const container = document.getElementById('tag-container');
            const btn = container.querySelector('button[onclick="showTagInput()"]');
            const newTag = document.createElement('div');
            newTag.className = "group px-4 py-2 bg-white text-pink-500 rounded-full text-xs font-bold border border-pink-100 shadow-sm flex items-center animate__animated animate__zoomIn";
            newTag.innerHTML = `<span># ${tag}</span><button onclick="removeTag(this)" class="ml-2 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-circle-xmark"></i></button>`;
            container.insertBefore(newTag, btn);
            input.value = ''; hideTagInput();
            if(window.askXiaoYou) window.askXiaoYou('USER_ACTION', `ç”¨æˆ·æ·»åŠ äº†æ ‡ç­¾ï¼š${tag}`);
        }
    }

    document.getElementById('avatar-input').onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                const src = ev.target.result;
                document.getElementById('avatar-preview-container').innerHTML = `<img src="${src}" class="w-full h-full object-cover">`;
                const navAv = document.getElementById('nav-avatar');
                if(navAv) navAv.src = src;
            };
            reader.readAsDataURL(file);
            const fd = new FormData();
            fd.append('avatar', file);
            fetch('/user_center/', { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' }, body: fd })
            .then(r => r.json()).then(d => { if(d.status==='success') safeAskXiaoYou('USER_ACTION', 'ç”¨æˆ·æ›´æ¢äº†å¤´åƒ'); });
        }
    };

    // --- éªŒè¯è¾…åŠ©å‡½æ•° ---
    const validators = {
        phone: (val) => {
            if (!val) return ""; // å…è®¸ä¸ºç©º
            return /^1[3-9]\d{9}$/.test(val) ? "" : "æ‰‹æœºå·æ ¼å¼å¥½åƒä¸å¤ªå¯¹å“¦(ã£Â°Ğ”Â°;)ã£";
        },
        email: (val) => {
            if (!val) return "é‚®ç®±æ˜¯å¿…å¡«é¡¹å‘¢~";
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val) ? "" : "é‚®ç®±æ ¼å¼è¿˜æ²¡åŒæ­¥æˆåŠŸï¼Œæ£€æŸ¥ä¸€ä¸‹å§ï¼Ÿ";
        }
    };

    function showFieldError(id, msg) {
        const errorEl = document.getElementById(`${id}-error`);
        const inputEl = document.getElementById(`${id}-val`);
        if (msg) {
            errorEl.innerText = msg;
            errorEl.classList.remove('hidden');
            inputEl.classList.add('border-red-200');
        } else {
            errorEl.classList.add('hidden');
            inputEl.classList.remove('border-red-200');
        }
    }

    // ä¸ºè¾“å…¥æ¡†ç»‘å®šå®æ—¶éªŒè¯
    document.getElementById('phone-val').addEventListener('input', (e) => {
        showFieldError('phone', validators.phone(e.target.value));
    });
    document.getElementById('email-val').addEventListener('input', (e) => {
        showFieldError('email', validators.email(e.target.value));
    });

    // --- ä¿®æ”¹åçš„ä¿å­˜å‡½æ•° ---
    async function saveProfile(btn) {
        const phoneVal = document.getElementById('phone-val').value;
        const emailVal = document.getElementById('email-val').value;

        // 1. æäº¤å‰æœ€åçš„æ ¼å¼æ£€æŸ¥
        const phoneErr = validators.phone(phoneVal);
        const emailErr = validators.email(emailVal);

        if (phoneErr || emailErr) {
            showFieldError('phone', phoneErr);
            showFieldError('email', emailErr);
            // è®©å°æŸšåæ§½ä¸€ä¸‹
            safeAskXiaoYou('FORM_ERROR', 'æ‰‹æœºå·æˆ–é‚®ç®±æ ¼å¼æœ‰è¯¯ï¼Œæé†’ä¸»äººå†æ£€æŸ¥ä¸€ä¸‹å–µ~');
            return;
        }

        const originalText = btn.innerText;
        btn.innerText = "åŒæ­¥ä¸­...";

        // ... åŸæœ‰çš„ tagsã€birthday è·å–é€»è¾‘ ...
        const y = document.getElementById('birth-year').value;
        const m = document.getElementById('birth-month').value.padStart(2, '0');
        const d = document.getElementById('birth-day').value.padStart(2, '0');
        const tags = Array.from(document.querySelectorAll('#tag-container span')).map(s => s.innerText.replace('# ', ''));

        const payload = {
            gender: document.getElementById('gender-val').value,
            birthday: `${y}-${m}-${d}`,
            phone: phoneVal,
            email: emailVal,
            bio: document.getElementById('bio-val').value,
            tags: tags
        };

        try {
            const res = await fetch('/user_center/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(payload)
            });

            const result = await res.json();
            if (result.status === 'success') {
                document.getElementById('side-bio').innerText = `â€œ ${payload.bio || 'Masterè¿˜æ²¡å†™ç®€ä»‹å‘¢ï½'} â€`;
                document.getElementById('save-hint').style.opacity = '1';
                safeAskXiaoYou('USER_ACTION', 'ç”¨æˆ·ä¿®æ”¹å¹¶ä¿å­˜äº†æ¡£æ¡ˆèµ„æ–™');
                setTimeout(() => document.getElementById('save-hint').style.opacity = '0', 2000);
            } else {
                // å¦‚æœåç«¯æŠ¥é”™ï¼ˆä¾‹å¦‚æ‰‹æœºå·å·²è¢«å ç”¨ï¼‰ï¼Œç›´æ¥æ˜¾ç¤ºåœ¨å¯¹åº”ä½ç½®
                if (result.message.includes('æ‰‹æœº')) showFieldError('phone', result.message);
                else if (result.message.includes('é‚®ç®±')) showFieldError('email', result.message);
                else safeAskXiaoYou('FORM_ERROR', result.message);
            }
        } catch (e) {
            console.error(e);
        } finally {
            btn.innerText = originalText;
        }
    }

    function safeAskXiaoYou(type, content = '') {
        if (window.askXiaoYou) window.askXiaoYou(type, content);
    }

    window.addEventListener('DOMContentLoaded', () => {
        initDateSelects();
        const currentGender = document.getElementById('gender-val').value;
        const indexMap = { 'male': 0, 'female': 1, 'cat': 2, 'alien': 3 };
        switchGender(indexMap[currentGender] || 1, currentGender, false);
        setTimeout(() => safeAskXiaoYou('USER_CENTER'), 1200);
    });
</script>
{% endblock %}