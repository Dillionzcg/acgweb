{% extends 'base.html' %}
{% load static %}  {% block title %}ä¸ªäººä¸­å¿ƒ{% endblock %}

{% block content %}
    <style>
    /* 2*2 æ€§åˆ«é€‰æ‹©å™¨å®¹å™¨ */
    .gender-grid-container {
        display: grid;
        grid-template-cols: repeat(2, 1fr);
        gap: 12px;
        padding: 8px;
        background: rgba(255, 241, 242, 0.5); /* pink-50/50 */
        border-radius: 24px;
        border: 1px solid rgba(252, 231, 235, 1); /* pink-100 */
        position: relative;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    /* é€‰ä¸­çš„ç™½è‰²ç²‰åœ†æ»‘å— */
    #gender-slider {
        position: absolute;
        background: white;
        border-radius: 16px;
        z-index: 0;
        box-shadow: 0 4px 12px rgba(244, 114, 182, 0.15),
                    0 2px 4px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.8);
        /* è¿™é‡Œçš„ transition å†³å®šäº†æ»‘åŠ¨çš„ä¸æ»‘æ„Ÿ */
        transition: all 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    /* æŒ‰é’®åŸºç¡€æ ·å¼ */
    .gender-btn {
        position: relative;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px 8px;
        font-size: 0.875rem; /* text-sm */
        font-weight: 700;
        color: #9ca3af; /* gray-400/500 */
        border-radius: 16px;
        transition: all 0.2s ease;
        cursor: pointer;
        background: transparent;
        border: none;
    }

    /* æŒ‰é’®æ–‡å­—é€‰ä¸­æ€ */
    .gender-btn.active-text {
        color: #ec4899; /* pink-500 */
        transform: scale(1.05);
    }

    /* æŒ‰é’®ç‚¹å‡»æ—¶çš„å¾®ç¼©åé¦ˆ */
    .gender-btn:active {
        transform: scale(0.92);
    }

    /* å›¾æ ‡é—´è· */
    .gender-btn span {
        margin-right: 8px;
        font-size: 1.1rem;
    }

    /* å“åº”å¼å¾®è°ƒï¼šå¦‚æœæ˜¯æ‰‹æœºç«¯ï¼Œé«˜åº¦å¯ä»¥ç¨å¾®ç¼©å‡ */
    @media (max-width: 640px) {
        .gender-btn {
            padding: 12px 6px;
        }
    }
</style>
<div class="max-w-5xl mx-auto px-4 py-10 animate__animated animate__fadeIn">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">

        <div class="lg:col-span-1">
            <div class="glass-card p-8 text-center relative border-2 border-pink-100">
                <a href="{% url 'index' %}" class="absolute top-5 left-5 w-10 h-10 flex items-center justify-center bg-pink-500 text-white rounded-full shadow-lg hover:bg-pink-600 hover:scale-110 transition-all z-10">
                    <i class="fa-solid fa-arrow-left text-lg"></i>
                </a>

                <div class="relative w-36 h-36 mx-auto mb-6 mt-4">
                    <div id="avatar-preview-container" class="w-full h-full rounded-3xl border-4 border-white shadow-xl bg-pink-50 overflow-hidden flex items-center justify-center">
                        {% if user.avatar %}
                            <img src="{{ user.avatar.url }}" class="w-full h-full object-cover">
                        {% else %}
                            <img src="{% static 'images/default_head.png' %}" class="w-full h-full object-cover">
                        {% endif %}
                    </div>
                    <label for="avatar-input" class="absolute bottom-0 right-0 w-10 h-10 bg-pink-500 text-white rounded-2xl border-4 border-white flex items-center justify-center cursor-pointer hover:scale-110 transition-all shadow-lg">
                        <i class="fa-solid fa-camera-retro"></i>
                    </label>
                    <input type="file" id="avatar-input" class="hidden" accept="image/*">
                </div>

                <h2 class="text-2xl font-bold text-gray-800">{{ user.username }}</h2>
                <p id="side-bio" class="text-sm text-pink-400 mt-2 italic">â€œ {{ user.bio|default:"Masterè¿˜æ²¡å†™ç®€ä»‹å‘¢ï½" }} â€</p>

                <div class="mt-8 flex justify-center space-x-4">
                    <div class="text-center">
                        <div class="text-xl font-bold text-pink-500">233</div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest">æ”¶è—</div>
                    </div>
                    <div class="w-px h-8 bg-pink-100 self-center"></div>
                    <div class="text-center">
                        <div class="text-xl font-bold text-pink-500">12k</div>
                        <div class="text-[10px] text-gray-400 uppercase tracking-widest">äººæ°”</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-8">
            <div class="glass-card p-10">
                <div class="flex items-center justify-between mb-10">
                    <div>
                        <h3 class="text-2xl font-bold text-gray-800">æ¡£æ¡ˆç¼–è¾‘</h3>
                        <p class="text-xs text-pink-300 mt-1">å®Œå–„ä½ çš„æ¬¡å…ƒé€šè¡Œè¯ä¿¡æ¯</p>
                    </div>
                    <div id="save-hint" class="opacity-0 transition-opacity bg-green-100 text-green-600 px-4 py-2 rounded-full text-xs font-bold">
                        <i class="fa-solid fa-circle-check mr-1"></i> åŒæ­¥æˆåŠŸ
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">æ¬¡å…ƒæ€§åˆ«</label>
                        <div class="relative grid grid-cols-2 gap-3 p-1.5 bg-pink-50/50 rounded-[2rem] border border-pink-100 shadow-inner">
                            <div id="gender-slider"
                                 class="absolute bg-white rounded-2xl shadow-sm transition-all duration-300 ease-out z-0"
                                 style="width: calc(50% - 0.75rem); height: calc(50% - 0.75rem); top: 0.375rem; left: 0.375rem;">
                            </div>

                            <button type="button" onclick="switchGender(0, 'male')"
                                    class="gender-btn relative flex items-center justify-center py-4 px-2 rounded-2xl text-sm font-bold z-10 transition-all duration-200 active:scale-95 text-gray-500">
                                <span class="mr-2">â™‚ï¸</span>å°‘å¹´
                            </button>
                            <button type="button" onclick="switchGender(1, 'female')"
                                    class="gender-btn relative flex items-center justify-center py-4 px-2 rounded-2xl text-sm font-bold z-10 transition-all duration-200 active:scale-95 text-gray-500">
                                <span class="mr-2">â™€ï¸</span>å°‘å¥³
                            </button>
                            <button type="button" onclick="switchGender(2, 'cat')"
                                    class="gender-btn relative flex items-center justify-center py-4 px-2 rounded-2xl text-sm font-bold z-10 transition-all duration-200 active:scale-95 text-gray-500">
                                <span class="mr-2">ğŸ¾</span>çŒ«çŒ«
                            </button>
                            <button type="button" onclick="switchGender(3, 'alien')"
                                    class="gender-btn relative flex items-center justify-center py-4 px-2 rounded-2xl text-sm font-bold z-10 transition-all duration-200 active:scale-95 text-gray-500">
                                <span class="mr-2">ğŸ›¸</span>å¤–æ˜Ÿç”Ÿå‘½
                            </button>

                            <input type="hidden" id="gender-val" value="{{ user.gender|default:'female' }}">
                        </div>
                    </div>

                    <div class="space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">è¯ç”Ÿçºªå¿µæ—¥</label>
                        <div class="flex space-x-2">
                            <select id="birth-year" class="flex-1 px-3 py-3 bg-white/70 border-2 border-pink-50 rounded-2xl focus:border-pink-300 outline-none transition-all shadow-sm text-sm text-gray-600 appearance-none text-center cursor-pointer"></select>
                            <select id="birth-month" class="w-20 px-1 py-3 bg-white/70 border-2 border-pink-50 rounded-2xl focus:border-pink-300 outline-none transition-all shadow-sm text-sm text-gray-600 appearance-none text-center cursor-pointer"></select>
                            <select id="birth-day" class="w-20 px-1 py-3 bg-white/70 border-2 border-pink-50 rounded-2xl focus:border-pink-300 outline-none transition-all shadow-sm text-sm text-gray-600 appearance-none text-center cursor-pointer"></select>
                        </div>
                        <input type="hidden" id="birthday-val" value="{{ user.birthday|date:'Y-m-d' }}">
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">æ¬¡å…ƒæ ¼è¨€ (Bio)</label>
                        <textarea id="bio-val" rows="3"
                                  class="w-full px-6 py-4 bg-white/70 border-2 border-pink-50 rounded-3xl focus:border-pink-300 outline-none transition-all shadow-sm resize-none"
                                  placeholder="å†™ç‚¹ä»€ä¹ˆè®©å¤§å®¶è®°ä½ä½ å§...">{{ user.bio }}</textarea>
                    </div>

                    <div class="md:col-span-2 space-y-3">
                        <label class="block text-sm font-bold text-gray-600 ml-2">å…´è¶£æ ‡ç­¾ (Tags)</label>
                        <div id="tag-container" class="flex flex-wrap gap-3 p-4 bg-pink-50/30 rounded-3xl border-2 border-dashed border-pink-100 min-h-[80px]">
                            {% for tag in user.tags %}
                            <div class="group px-4 py-2 bg-white text-pink-500 rounded-full text-xs font-bold border border-pink-100 shadow-sm flex items-center animate__animated animate__zoomIn">
                                <span># {{ tag }}</span>
                                <button onclick="removeTag(this)" class="ml-2 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <i class="fa-solid fa-circle-xmark"></i>
                                </button>
                            </div>
                            {% endfor %}
                            <button onclick="showTagInput()" class="px-4 py-2 bg-pink-500/10 text-pink-500 rounded-full text-xs font-bold border border-pink-200 border-dashed hover:bg-pink-500 hover:text-white transition-all">
                                <i class="fa-solid fa-plus mr-1"></i> æ–°å¢æ ‡ç­¾
                            </button>
                        </div>
                        <div id="tag-input-box" class="hidden animate__animated animate__fadeInUp mt-4">
                            <div class="flex space-x-2">
                                <input type="text" id="new-tag-input" class="flex-1 px-5 py-2 rounded-full border border-pink-200 outline-none focus:ring-2 focus:ring-pink-300" placeholder="è¾“å…¥æ ‡ç­¾å...">
                                <button onclick="addTag()" class="bg-pink-500 text-white px-6 py-2 rounded-full font-bold hover:bg-pink-600 transition-all">ç¡®è®¤</button>
                                <button onclick="hideTagInput()" class="bg-gray-100 text-gray-500 px-4 py-2 rounded-full font-bold hover:bg-gray-200 transition-all">å–æ¶ˆ</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-12">
                    <button onclick="saveProfile(this)"
                            class="w-full py-5 bg-gradient-to-r from-pink-400 to-pink-500 text-white rounded-full font-bold text-lg shadow-lg hover:shadow-pink-200 hover:scale-[1.01] active:scale-95 transition-all">
                        ç¡®è®¤åŒæ­¥åˆ°æ¬¡å…ƒæ¡£æ¡ˆ
                    </button>
                </div>
            </div>

            <!-- Friend System Section -->
            <div class="glass-card p-10 mt-8">
                <h3 class="text-2xl font-bold text-gray-800 mb-6">ç¾ç»Šç³»ç»Ÿ</h3>
                
                <!-- Tabs -->
                <div class="flex space-x-4 mb-6 border-b border-pink-100 pb-2">
                    <button onclick="showFriendTab('list')" id="tab-btn-list" class="px-4 py-2 text-pink-500 font-bold border-b-2 border-pink-500 transition-colors">æˆ‘çš„å¥½å‹</button>
                    <button onclick="showFriendTab('requests')" id="tab-btn-requests" class="px-4 py-2 text-gray-400 hover:text-pink-400 font-bold transition-colors">å¥½å‹è¯·æ±‚</button>
                    <button onclick="showFriendTab('add')" id="tab-btn-add" class="px-4 py-2 text-gray-400 hover:text-pink-400 font-bold transition-colors">æ·»åŠ å¥½å‹</button>
                </div>

                <!-- Friend List -->
                <div id="friend-tab-list" class="animate__animated animate__fadeIn">
                    <div id="friends-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- Content loaded via JS -->
                        <div class="text-center text-gray-400 py-8 w-full col-span-2">åŠ è½½ä¸­...</div>
                    </div>
                </div>

                <!-- Requests -->
                <div id="friend-tab-requests" class="hidden animate__animated animate__fadeIn">
                    <div id="requests-container" class="space-y-4">
                        <!-- Content loaded via JS -->
                        <div class="text-center text-gray-400 py-8">æš‚æ— æ–°çš„è¯·æ±‚</div>
                    </div>
                </div>

                <!-- Add Friend -->
                <div id="friend-tab-add" class="hidden animate__animated animate__fadeIn">
                    <div class="flex space-x-2 mb-6">
                        <input type="text" id="search-friend-input" class="flex-1 px-5 py-3 border-2 border-pink-100 rounded-2xl outline-none focus:border-pink-300" placeholder="è¾“å…¥IDæˆ–ç”¨æˆ·åæœç´¢...">
                        <button onclick="searchUsers()" class="px-6 py-3 bg-pink-500 text-white rounded-2xl font-bold hover:bg-pink-600 transition-all">æœç´¢</button>
                    </div>
                    <div id="search-results" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Friend System Logic ---
    let currentFriendTab = 'list';

    function showFriendTab(tab) {
        currentFriendTab = tab;
        ['list', 'requests', 'add'].forEach(t => {
            document.getElementById(`friend-tab-${t}`).classList.add('hidden');
            document.getElementById(`tab-btn-${t}`).classList.remove('text-pink-500', 'border-b-2', 'border-pink-500');
            document.getElementById(`tab-btn-${t}`).classList.add('text-gray-400');
        });
        document.getElementById(`friend-tab-${tab}`).classList.remove('hidden');
        const activeBtn = document.getElementById(`tab-btn-${tab}`);
        activeBtn.classList.remove('text-gray-400');
        activeBtn.classList.add('text-pink-500', 'border-b-2', 'border-pink-500');

        if (tab === 'list' || tab === 'requests') loadFriendsData();
    }

    async function loadFriendsData() {
        try {
            const res = await fetch('/auth/api/friends/');
            const data = await res.json();
            renderFriends(data.friends);
            renderRequests(data.requests);
        } catch (e) { console.error("Failed to load friends", e); }
    }

    function renderFriends(friends) {
        const container = document.getElementById('friends-container');
        if (friends.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 py-8 col-span-2">è¿˜æ²¡æœ‰å»ºç«‹ç¾ç»Šå“¦ï½å¿«å»æ·»åŠ å¥½å‹å§ï¼</div>`;
            return;
        }
        container.innerHTML = friends.map(f => `
            <div class="flex items-center p-4 bg-white rounded-2xl border border-pink-50 shadow-sm hover:shadow-md transition-shadow">
                <img src="${f.avatar || '/static/images/default_head.png'}" class="w-12 h-12 rounded-full object-cover border-2 border-white shadow-sm mr-4">
                <div>
                    <div class="font-bold text-gray-800">${f.username}</div>
                    <div class="text-xs text-gray-400 truncate max-w-[150px]">${f.bio || 'è¿™ä¸ªäººå¾ˆæ‡’...'}</div>
                </div>
                <button onclick="startChat('${f.id}', '${f.username}')" class="ml-auto w-8 h-8 flex items-center justify-center bg-pink-100 text-pink-500 rounded-full hover:bg-pink-500 hover:text-white transition-all">
                    <i class="fa-solid fa-comment-dots"></i>
                </button>
            </div>
        `).join('');
    }

    function renderRequests(requests) {
        const container = document.getElementById('requests-container');
        document.getElementById('tab-btn-requests').innerHTML = `å¥½å‹è¯·æ±‚ ${requests.length > 0 ? `<span class="ml-1 px-2 py-0.5 bg-red-500 text-white text-[10px] rounded-full">${requests.length}</span>` : ''}`;
        
        if (requests.length === 0) {
            container.innerHTML = `<div class="text-center text-gray-400 py-8">æš‚æ— æ–°çš„è¯·æ±‚</div>`;
            return;
        }
        container.innerHTML = requests.map(r => `
            <div class="flex items-center justify-between p-4 bg-pink-50/30 rounded-2xl border border-pink-100">
                <div class="flex items-center">
                    <img src="${r.from_user.avatar || '/static/images/default_head.png'}" class="w-10 h-10 rounded-full object-cover mr-3">
                    <span class="font-bold text-gray-700">${r.from_user.username}</span>
                    <span class="text-xs text-gray-400 ml-2">è¯·æ±‚å»ºç«‹ç¾ç»Š</span>
                </div>
                <div class="flex space-x-2">
                    <button onclick="handleRequest(${r.id}, 'accept')" class="px-3 py-1 bg-green-500 text-white text-xs rounded-full hover:bg-green-600 transition">æ¥å—</button>
                    <button onclick="handleRequest(${r.id}, 'reject')" class="px-3 py-1 bg-gray-300 text-white text-xs rounded-full hover:bg-gray-400 transition">å¿½ç•¥</button>
                </div>
            </div>
        `).join('');
    }

    async function searchUsers() {
        const query = document.getElementById('search-friend-input').value;
        if (!query) return;
        
        const btn = document.querySelector('#friend-tab-add button');
        const originalText = btn.innerText;
        btn.innerText = "Searching...";
        
        try {
            const res = await fetch(`/auth/api/search/?q=${encodeURIComponent(query)}`);
            const users = await res.json();
            const container = document.getElementById('search-results');
            
            if (users.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-400">æœªæ‰¾åˆ°åä¸º "${query}" çš„ç”¨æˆ·</div>`;
            } else {
                container.innerHTML = users.map(u => {
                    let actionBtn = '';
                    if (u.friend_status === 'friend') {
                        actionBtn = `<span class="text-xs text-green-500 font-bold"><i class="fa-solid fa-check"></i> å·²æ˜¯å¥½å‹</span>`;
                    } else if (u.friend_status === 'sent') {
                        actionBtn = `<span class="text-xs text-gray-400">å·²å‘é€è¯·æ±‚</span>`;
                    } else if (u.friend_status === 'received') {
                        actionBtn = `<span class="text-xs text-pink-500">å¯¹æ–¹å·²è¯·æ±‚</span>`;
                    } else {
                        actionBtn = `<button onclick="sendRequest(${u.id}, this)" class="px-4 py-1.5 bg-pink-500 text-white text-xs rounded-full hover:bg-pink-600 transition"><i class="fa-solid fa-user-plus mr-1"></i> æ·»åŠ </button>`;
                    }
                    
                    return `
                    <div class="flex items-center justify-between p-4 bg-white rounded-2xl border border-gray-100 shadow-sm">
                        <div class="flex items-center">
                            <img src="${u.avatar ? '/media/'+u.avatar : '/static/images/default_head.png'}" class="w-10 h-10 rounded-full object-cover mr-3">
                            <div>
                                <div class="font-bold text-gray-800">${u.username}</div>
                                <div class="text-xs text-gray-400 truncate max-w-[200px]">${u.bio || 'æš‚æ— ç®€ä»‹'}</div>
                            </div>
                        </div>
                        ${actionBtn}
                    </div>`;
                }).join('');
            }
        } finally {
            btn.innerText = originalText;
        }
    }

    async function sendRequest(targetId, btn) {
        btn.disabled = true;
        btn.innerText = "å‘é€ä¸­...";
        try {
            const res = await fetch('/auth/api/friend/request/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ target_id: targetId })
            });
            const data = await res.json();
            if (data.status === 'success') {
                btn.className = "text-xs text-gray-400";
                btn.innerText = "å·²å‘é€è¯·æ±‚";
                btn.onclick = null;
            } else {
                alert(data.message || "å‘é€å¤±è´¥");
                btn.disabled = false;
                btn.innerText = "æ·»åŠ ";
            }
        } catch (e) { console.error(e); }
    }

    async function handleRequest(reqId, action) {
        try {
            const res = await fetch('/auth/api/friend/handle/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify({ request_id: reqId, action: action })
            });
            const data = await res.json();
            if (data.status === 'success') {
                loadFriendsData(); // Reload lists
            }
        } catch (e) { console.error(e); }
    }

    // Call from friend list to open chat
    function startChat(userId, username) {
        // Trigger the global chat widget
        const fab = document.getElementById('chat-fab');
        if (fab) {
            // If chat is closed, open it
            if (fab.style.display !== 'none') fab.click(); 
            
            // Wait a bit for widget to init then switch room
            setTimeout(() => {
                // We need to access the internal switchRoom of chat widget. 
                // Since it's inside a closure, we can't call it directly.
                // But we can simulate a click on the user list in the widget if we find it.
                // Alternative: We expose a global function in chat_widget.html
                if (window.openPrivateChat) {
                    window.openPrivateChat(userId, username);
                } else {
                    alert("èŠå¤©ç»„ä»¶æ­£åœ¨åˆå§‹åŒ–ï¼Œè¯·ç¨åå†è¯•");
                }
            }, 100);
        }
    }

    // Load initial data
    window.addEventListener('DOMContentLoaded', () => {
        // ... previous init code ...
        loadFriendsData();
    });

    // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©æ¡†
    function initDateSelects() {
    const yearSelect = document.getElementById('birth-year');
    const monthSelect = document.getElementById('birth-month');
    const daySelect = document.getElementById('birth-day');
    const currentVal = document.getElementById('birthday-val').value;

    // é»˜è®¤æ—¥æœŸé€»è¾‘ï¼šå¦‚æœæœ‰æ—§å€¼ç”¨æ—§å€¼ï¼Œå¦åˆ™é»˜è®¤ 2000-01-01 (æ›´ç¬¦åˆäºŒæ¬¡å…ƒç”¨æˆ·ä¹ æƒ¯)
    let dateObj = (currentVal && currentVal !== 'None') ? new Date(currentVal) : null;

    // 1. åˆå§‹åŒ–å¹´ä»½ (1970 - ä»Šå¹´)
    const currentYear = new Date().getFullYear();
    yearSelect.innerHTML = ''; // æ¸…ç©ºé˜²é‡å 
    for (let i = currentYear; i >= 1970; i--) {
        yearSelect.add(new Option(`${i} å¹´`, i));
    }

    // 2. åˆå§‹åŒ–æœˆä»½
    monthSelect.innerHTML = '';
    for (let i = 1; i <= 12; i++) {
        monthSelect.add(new Option(`${i} æœˆ`, i));
    }

    // 3. æ›´æ–°â€œæ—¥â€çš„å‡½æ•°
    function updateDays(targetDay = null) {
        const y = yearSelect.value;
        const m = monthSelect.value;
        if (!y || !m) return;

        const totalDays = new Date(y, m, 0).getDate();

        // è®°å½•å½“å‰å·²ç»é€‰ä¸­çš„æ—¥ï¼Œé˜²æ­¢åˆ‡æ¢å¹´æœˆæ—¶é‡ç½®
        const lastSelected = targetDay || daySelect.value;

        daySelect.innerHTML = '';
        for (let i = 1; i <= totalDays; i++) {
            daySelect.add(new Option(`${i} æ—¥`, i));
        }

        // æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿å€¼è¢«æ­£ç¡®é€‰ä¸­
        if (lastSelected && lastSelected <= totalDays) {
            daySelect.value = lastSelected;
        } else {
            daySelect.selectedIndex = 0; // é»˜è®¤é€‰ä¸­ 1 æ—¥
        }
    }

    // ç»‘å®šäº‹ä»¶
    yearSelect.onchange = () => updateDays();
    monthSelect.onchange = () => updateDays();

    // 4. åˆæ¬¡è¿›å…¥çš„èµ‹å€¼é€»è¾‘
    if (dateObj && !isNaN(dateObj.getTime())) {
        yearSelect.value = dateObj.getFullYear();
        monthSelect.value = dateObj.getMonth() + 1;
        // ä¼ å…¥å…·ä½“çš„â€œæ—¥â€è¿›è¡Œåˆå§‹åŒ–ï¼Œç¡®ä¿åœ¨ option ç”Ÿæˆåç«‹å³é€‰ä¸­
        updateDays(dateObj.getDate());
    } else {
        // å¦‚æœæ²¡æœ‰é¢„è®¾ç”Ÿæ—¥ï¼Œé»˜è®¤åˆå§‹åŒ–ä¸€æ¬¡
        updateDays(1);
    }
}

    function switchGender(index, value, shouldAsk = true) {
    const slider = document.getElementById('gender-slider');
    const valInput = document.getElementById('gender-val');
    const buttons = document.querySelectorAll('.gender-btn');

    // 1. æ›´æ–°éšè—å€¼
    valInput.value = value;

    // 2. 2x2 åæ ‡è®¡ç®—
    // index 0: (0,0), 1: (1,0), 2: (0,1), 3: (1,1)
    const col = index % 2;
    const row = Math.floor(index / 2);

    // è®¡ç®—ä½ç§»ç™¾åˆ†æ¯”
    const leftPos = col * 50;
    const topPos = row * 50;

    // åº”ç”¨åŠ¨ç”»å¹³ç§»
    slider.style.left = `calc(${leftPos}% + 0.375rem)`;
    slider.style.top = `calc(${topPos}% + 0.375rem)`;

    // 3. UI çŠ¶æ€åé¦ˆ
    buttons.forEach((btn, i) => {
        if (i === index) {
            btn.classList.add('text-pink-500', 'scale-105');
            btn.classList.remove('text-gray-500');
        } else {
            btn.classList.remove('text-pink-500', 'scale-105');
            btn.classList.add('text-gray-500');
        }
    });

    // 4. è”åŠ¨å°æŸš (ä¿æŒä½ åŸæœ‰çš„é€»è¾‘)
    if (shouldAsk) {
        const genderNames = ["å°‘å¹´", "å°‘å¥³", "çŒ«çŒ«", "å¤–æ˜Ÿç”Ÿå‘½"];
        safeAskXiaoYou('USER_UPDATE', `æˆ‘æŠŠæ€§åˆ«æ”¹æˆ${genderNames[index]}å•¦ï¼ï¼ˆè¯·ä¸»è¦æ¸©æŸ”ä¸”å¯çˆ±åœ°è¡¨è¾¾å¯¹ä¸»äººæ€§åˆ«çš„å–œçˆ±ï¼‰ï¼ˆæ³¨æ„å¦‚æœæ˜¯çŒ«çŒ«çš„è¯æƒ…ç»ªä»£ç ä¸€å®šè¦æ˜¯å–œæ¬¢ï¼ˆ6ï¼‰`);
    }
}

    function showTagInput() { document.getElementById('tag-input-box').classList.remove('hidden'); }
    function hideTagInput() { document.getElementById('tag-input-box').classList.add('hidden'); }

    function addTag() {
        const input = document.getElementById('new-tag-input');
        const tag = input.value.trim();
        if(tag) {
            const container = document.getElementById('tag-container');
            const btn = container.querySelector('button[onclick="showTagInput()"]');
            const newTag = document.createElement('div');
            newTag.className = "group px-4 py-2 bg-white text-pink-500 rounded-full text-xs font-bold border border-pink-100 shadow-sm flex items-center animate__animated animate__zoomIn";
            newTag.innerHTML = `<span># ${tag}</span><button onclick="removeTag(this)" class="ml-2 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><i class="fa-solid fa-circle-xmark"></i></button>`;
            container.insertBefore(newTag, btn);
            input.value = '';
            hideTagInput();

            if(window.askXiaoYou) window.askXiaoYou('USER_ACTION', `ç”¨æˆ·åœ¨ä¸ªäººèµ„æ–™æ·»åŠ äº†æ–°æ ‡ç­¾ï¼š${tag},è¯·ä½œå‡ºä¸å°‘äº60å­—çš„æ°å½“å›å¤ï¼Œæ³¨æ„è¯·ä¸è¦æ”¹å˜â€ä¸»äººâ€œçš„ç§°å‘¼`);
        }
    }

    function removeTag(el) { el.parentElement.remove(); }

    async function saveProfile(btn) {
        const originalText = btn.innerText;
        btn.innerText = "åŒæ­¥ä¸­...";

        // æ•´åˆæ—¥æœŸ
        const y = document.getElementById('birth-year').value;
        const m = document.getElementById('birth-month').value.padStart(2, '0');
        const d = document.getElementById('birth-day').value.padStart(2, '0');
        const finalBirthday = `${y}-${m}-${d}`;

        const tags = Array.from(document.querySelectorAll('#tag-container span')).map(s => s.innerText.replace('# ', ''));
        const payload = {
            gender: document.getElementById('gender-val').value,
            birthday: finalBirthday,
            bio: document.getElementById('bio-val').value,
            tags: tags
        };

        try {
            const res = await fetch('/user_center/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                body: JSON.stringify(payload)
            });
            const d_res = await res.json();
            if(d_res.status === 'success') {
                document.getElementById('side-bio').innerText = payload.bio || "Masterè¿˜æ²¡å†™ç®€ä»‹å‘¢ï½";
                document.getElementById('save-hint').style.opacity = '1';
                if(window.askXiaoYou) window.askXiaoYou('USER_ACTION', 'ç”¨æˆ·ä¿®æ”¹å¹¶ä¿å­˜äº†æ¡£æ¡ˆèµ„æ–™');
                setTimeout(() => document.getElementById('save-hint').style.opacity = '0', 2000);
            }
        } catch (e) {
            console.error(e);
        } finally {
            btn.innerText = originalText;
        }
    }

    function safeAskXiaoYou(type, content = '') {
        let attempts = 0;
        const interval = setInterval(() => {
            attempts++;
            if (window.askXiaoYou) {
                window.askXiaoYou(type, content);
                clearInterval(interval);
            }
            if (attempts > 50) clearInterval(interval);
        }, 100);
    }

    window.addEventListener('DOMContentLoaded', () => {
        // åˆå§‹åŒ–æ—¥æœŸä¸‹æ‹‰
        initDateSelects();

        const currentGender = document.getElementById('gender-val').value;
        const indexMap = { 'male': 0, 'female': 1, 'cat': 2, 'alien': 3 };
        switchGender(indexMap[currentGender] || 1, currentGender, false);

        setTimeout(() => {
            safeAskXiaoYou('USER_CENTER');
        }, 1200);
    });

    document.getElementById('avatar-input').onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const newImageSrc = ev.target.result;
            // 1. æ›´æ–°ä¸ªäººä¸­å¿ƒçš„å¤§é¢„è§ˆå›¾
            document.getElementById('avatar-preview-container').innerHTML = `<img src="${newImageSrc}" class="w-full h-full object-cover">`;

            // 2. ã€æ–°å¢ã€‘åŒæ­¥æ›´æ–°é¡¶éƒ¨å¯¼èˆªæ çš„å¤´åƒ
            const navAvatar = document.getElementById('nav-avatar');
            if (navAvatar) {
                navAvatar.src = newImageSrc;
            }
        };
        reader.readAsDataURL(file);

        // å‘é€ç»™åç«¯çš„ä»£ç ä¿æŒä¸å˜...
        const fd = new FormData();
        fd.append('avatar', file);
        fetch('/user_center/', {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: fd
        }).then(r => r.json()).then(d => {
            if(d.status==='success') {
               if(window.askXiaoYou) window.askXiaoYou('USER_ACTION', 'ç”¨æˆ·æ›´æ¢äº†å¤´åƒ');
            }
        });
    }
};
</script>
{% endblock %}