<style>
    /* Chat Widget Styles */
    #chat-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #chat-fab:hover { transform: scale(1.1) rotate(10deg); }
    #chat-fab i { color: white; font-size: 24px; }

    #chat-window {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 350px;
        height: 450px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        z-index: 1000;
        border: 1px solid rgba(255, 182, 193, 0.3);
        overflow: hidden;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .chat-header {
        padding: 12px 15px;
        background: linear-gradient(to right, #ff9a9e, #fad0c4);
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move;
        font-size: 14px;
    }
    .chat-close { cursor: pointer; opacity: 0.8; }
    .chat-close:hover { opacity: 1; }

    .chat-body { display: flex; flex: 1; overflow: hidden; position: relative; }
    
    #user-list-sidebar {
        width: 120px;
        background: rgba(255, 255, 255, 0.5);
        border-right: 1px solid rgba(255, 182, 193, 0.2);
        display: none;
        flex-direction: column;
        overflow-y: auto;
    }
    .user-item {
        padding: 10px 12px;
        font-size: 12px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 182, 193, 0.1);
        transition: all 0.2s;
        color: #666;
    }
    .user-item:hover { background: #fff0f5; color: #ff9a9e; }
    .user-item.active { background: #ff9a9e; color: white; font-weight: bold; }

    #chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: transparent;
    }

    .message-bubble {
        max-width: 85%;
        padding: 8px 12px;
        border-radius: 15px;
        font-size: 13px;
        line-height: 1.4;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .message-bubble.received { align-self: flex-start; background: white; color: #444; border-bottom-left-radius: 2px; }
    .message-bubble.sent { align-self: flex-end; background: #ff9a9e; color: white; border-bottom-right-radius: 2px; }

    .chat-input-area {
        padding: 12px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        gap: 8px;
        background: white;
    }
    #chat-widget-input {
        flex: 1;
        border: 1px solid #eee;
        border-radius: 20px;
        padding: 6px 15px;
        outline: none;
        font-size: 13px;
    }
    #chat-widget-send { background: #ff9a9e; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; justify-content: center; align-items: center; }

    /* Custom Alert Modal Style */
    #custom-alert {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1100;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .alert-content { background: white; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid #ffeff3; width: 80%; }
    .alert-text { color: #ff6b81; font-weight: bold; margin-bottom: 15px; font-size: 13px; }
    .alert-btn { padding: 6px 20px; border-radius: 20px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
    .btn-login { background: #ff9a9e; color: white; }
    .btn-cancel { background: #f1f2f6; color: #a4b0be; margin-left: 5px; }
</style>

<div id="chat-fab" title="Chat with us!">
    <i class="fas fa-comment-dots"></i>
</div>

<div id="chat-window">
    <div class="chat-header">
        <div style="display: flex; align-items: center;">
            <i class="fas fa-bars" id="toggle-users" style="margin-right: 10px; cursor: pointer;" title="切换房间"></i>
            <span id="chat-title">ACG 大厅</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <i class="fas fa-times chat-close" id="close-chat"></i>
        </div>
    </div>
    <div class="chat-body">
        <div id="user-list-sidebar">
            <div class="user-item active" data-type="lobby">公共大厅</div>
            <div id="online-users-container"></div>
        </div>
        <div id="chat-messages">
            <div class="message-bubble received">你好！欢迎来到 ACG 聊天室~</div>
        </div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-widget-input" placeholder="说点什么..." autocomplete="off">
        <button id="chat-widget-send"><i class="fas fa-paper-plane"></i></button>
    </div>

    <div id="custom-alert">
        <div class="alert-content">
            <div class="alert-text" id="alert-msg">请先登录后再发言</div>
            <div>
                <button class="alert-btn btn-login" onclick="window.location.href='/auth/login/'">去登录</button>
                <button class="alert-btn btn-cancel" onclick="document.getElementById('custom-alert').style.display='none'">再看看</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fab = document.getElementById('chat-fab');
        const chatWindow = document.getElementById('chat-window');
        const closeBtn = document.getElementById('close-chat');
        const toggleUsersBtn = document.getElementById('toggle-users');
        const sidebar = document.getElementById('user-list-sidebar');
        const onlineUsersContainer = document.getElementById('online-users-container');
        const chatTitle = document.getElementById('chat-title');
        const msgInput = document.getElementById('chat-widget-input');
        const sendBtn = document.getElementById('chat-widget-send');
        const msgContainer = document.getElementById('chat-messages');

        let chatSocket = null;
        let currentRoom = 'lobby';
        const myId = "{{ user.id }}";
        const myUsername = "{{ user.username }}";

        // --- UI Logic ---
        fab.addEventListener('click', () => {
            chatWindow.style.display = 'flex';
            if (!chatWindow.style.top) {
                const rect = chatWindow.getBoundingClientRect();
                chatWindow.style.bottom = 'auto'; chatWindow.style.right = 'auto';
                chatWindow.style.top = rect.top + 'px'; chatWindow.style.left = rect.left + 'px';
            }
            fab.style.display = 'none';
            switchRoom('lobby', 'ACG 大厅');
            loadUserList();
        });

        closeBtn.addEventListener('click', () => {
            chatWindow.style.display = 'none';
            fab.style.display = 'flex';
        });

        toggleUsersBtn.addEventListener('click', () => {
            sidebar.style.display = sidebar.style.display === 'flex' ? 'none' : 'flex';
        });

        async function loadUserList() {
            try {
                const response = await fetch('/auth/api/users/');
                const users = await response.json();
                onlineUsersContainer.innerHTML = '';
                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.textContent = user.username;
                    div.onclick = () => {
                        const roomName = `private_${Math.min(myId, user.id)}_${Math.max(myId, user.id)}`;
                        switchRoom(roomName, `与 ${user.username} 私聊`);
                        // Update active class
                        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                    };
                    onlineUsersContainer.appendChild(div);
                });
            } catch (e) { console.error("Failed to load users", e); }
        }

        document.querySelector('[data-type="lobby"]').onclick = function() {
            switchRoom('lobby', 'ACG 大厅');
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
        };

        // --- Core Logic ---
        function switchRoom(roomName, title) {
            if (currentRoom === roomName && chatSocket) return;
            
            // Close old socket
            if (chatSocket) { chatSocket.close(); }
            
            currentRoom = roomName;
            chatTitle.textContent = title;
            msgContainer.innerHTML = ''; // Clear for history loading
            
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            chatSocket = new WebSocket(protocol + window.location.host + '/ws/chat/' + roomName + '/');

            chatSocket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                if (data.type === 'error') {
                    document.getElementById('alert-msg').textContent = data.message;
                    document.getElementById('custom-alert').style.display = 'flex';
                } else {
                    addMessage(data.message, data.sender === myUsername ? 'sent' : 'received', data.sender);
                }
            };
        }

        function sendMessage() {
            const message = msgInput.value.trim();
            if (message && chatSocket) {
                chatSocket.send(JSON.stringify({'message': message}));
                msgInput.value = '';
            }
        }

        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        function addMessage(text, type, senderName) {
            const div = document.createElement('div');
            div.className = `message-bubble ${type}`;
            if (type === 'received' && currentRoom === 'lobby') {
                const nameDiv = document.createElement('div');
                nameDiv.style.fontSize = '10px'; nameDiv.style.color = '#ff9a9e';
                nameDiv.style.marginBottom = '2px'; nameDiv.textContent = senderName;
                div.appendChild(nameDiv);
            }
            const textNode = document.createTextNode(text);
            div.appendChild(textNode);
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // Draggable
        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const dragHandle = handle || element;
            dragHandle.onmousedown = (e) => {
                if (e.target.closest('.chat-close') || e.target.closest('#toggle-users')) return;
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = (e) => {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                    pos3 = e.clientX; pos4 = e.clientY;
                    element.style.bottom = 'auto'; element.style.right = 'auto';
                    element.style.top = (element.offsetTop - pos2) + "px";
                    element.style.left = (element.offsetLeft - pos1) + "px";
                };
            };
        }
        makeDraggable(fab);
        makeDraggable(chatWindow, document.querySelector('.chat-header'));
    });
</script>
