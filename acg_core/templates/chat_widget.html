<style>
    /* Chat Widget Styles */
    #chat-fab {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%);
        border-radius: 50%;
        box-shadow: 0 4px 15px rgba(255, 105, 180, 0.4);
        display: flex;
        justify-content: center;
        align-items: center;
        cursor: pointer;
        z-index: 1000;
        transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #chat-fab:hover { transform: scale(1.1) rotate(10deg); }
    #chat-fab i { color: white; font-size: 24px; }

    #chat-window {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 350px;
        height: 450px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        display: none;
        flex-direction: column;
        z-index: 1001; /* Higher than FAB */
        border: 1px solid rgba(255, 182, 193, 0.3);
        overflow: hidden;
        animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .chat-header {
        padding: 12px 15px;
        background: linear-gradient(to right, #ff9a9e, #fad0c4);
        color: white;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: move;
        font-size: 14px;
    }
    .chat-close { cursor: pointer; opacity: 0.8; }
    .chat-close:hover { opacity: 1; }

    .chat-body { display: flex; flex: 1; overflow: hidden; position: relative; }
    
    #user-list-sidebar {
        width: 120px;
        background: rgba(255, 255, 255, 0.5);
        border-right: 1px solid rgba(255, 182, 193, 0.2);
        display: none;
        flex-direction: column;
        overflow-y: auto;
    }
    .user-item {
        padding: 10px 12px;
        font-size: 12px;
        cursor: pointer;
        border-bottom: 1px solid rgba(255, 182, 193, 0.1);
        transition: all 0.2s;
        color: #666;
    }
    .user-item:hover { background: #fff0f5; color: #ff9a9e; }
    .user-item.active { background: #ff9a9e; color: white; font-weight: bold; }

    #chat-messages {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        background: transparent;
    }

    .message-bubble {
        max-width: 85%;
        padding: 8px 12px;
        border-radius: 15px;
        font-size: 13px;
        line-height: 1.4;
        word-wrap: break-word;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .message-bubble.received { align-self: flex-start; background: white; color: #444; border-bottom-left-radius: 2px; }
    .message-bubble.sent { align-self: flex-end; background: #ff9a9e; color: white; border-bottom-right-radius: 2px; }

    .chat-input-area {
        padding: 12px;
        border-top: 1px solid #f0f0f0;
        display: flex;
        gap: 8px;
        background: white;
    }
    #chat-widget-input {
        flex: 1;
        border: 1px solid #eee;
        border-radius: 20px;
        padding: 6px 15px;
        outline: none;
        font-size: 13px;
    }
    #chat-widget-send { background: #ff9a9e; color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; display: flex; justify-content: center; align-items: center; }

    /* Custom Alert Modal Style */
    #custom-alert {
        position: absolute;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(255, 255, 255, 0.6);
        backdrop-filter: blur(4px);
        z-index: 1100;
        display: none;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .alert-content { background: white; padding: 20px; border-radius: 20px; text-align: center; border: 2px solid #ffeff3; width: 80%; }
    .alert-text { color: #ff6b81; font-weight: bold; margin-bottom: 15px; font-size: 13px; }
    .alert-btn { padding: 6px 20px; border-radius: 20px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
    .btn-login { background: #ff9a9e; color: white; }
    .btn-cancel { background: #f1f2f6; color: #a4b0be; margin-left: 5px; }

    /* --- Video Call Mode Styles --- */
    #chat-window.video-mode {
        /* No fixed position, handled by JS for drag */
        border-radius: 10px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
    }

    #chat-window.video-mode #video-container {
        display: flex !important;
        z-index: 0; /* Background layer */
        background: #000;
    }

    /* Message Overlay (Danmaku-ish) */
    #chat-window.video-mode #chat-messages {
        position: absolute;
        bottom: 60px;
        left: 10px;
        width: 300px;
        height: 250px;
        z-index: 10;
        background: transparent;
        overflow-y: hidden; /* Hide scrollbar */
        justify-content: flex-end; /* Align bottom */
        mask-image: linear-gradient(to bottom, transparent, black 20%);
        pointer-events: none; /* Click through */
    }

    #chat-window.video-mode .message-bubble {
        background: rgba(0, 0, 0, 0.6);
        color: white;
        border: none;
        box-shadow: none;
        margin-bottom: 8px;
        align-self: flex-start; /* All align left */
        animation: slideInLeft 0.3s ease-out;
        backdrop-filter: blur(2px);
    }
    
    #chat-window.video-mode .chat-input-area {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        z-index: 30; /* Higher than message overlay (10) */
        background: rgba(0,0,0,0.5);
        border-top: none;
    }
    
    /* Ensure hangup button is accessible */
    #chat-window.video-mode #hangup-video {
        z-index: 40; /* Highest priority */
        pointer-events: auto;
    }
    
    .video-controls {
        position: absolute; 
        bottom: 10px; 
        left: 10px; 
        gap: 10px;
        z-index: 50; /* Default high z-index */
    }

    #chat-window.video-mode #chat-widget-input {
        background: rgba(255,255,255,0.2);
        color: white;
        border: none;
    }
    #chat-window.video-mode #chat-widget-input::placeholder { color: rgba(255,255,255,0.7); }
    
    #chat-window.video-mode .video-controls {
        z-index: 9999 !important;
        pointer-events: all !important;
    }

    #chat-window.video-mode #user-list-sidebar { display: none; }
    
    @keyframes slideInLeft { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
</style>

<div id="chat-fab" title="Chat with us!">
    <i class="fas fa-comment-dots"></i>
</div>

<div id="chat-window">
    <div class="chat-header">
        <div style="display: flex; align-items: center;">
            <i class="fas fa-bars" id="toggle-users" style="margin-right: 10px; cursor: pointer;" title="切换房间"></i>
            <span id="chat-title">ACG 大厅</span>
        </div>
        <div style="display: flex; gap: 10px; align-items: center;">
            <i class="fas fa-video" id="start-video-call" style="cursor: pointer; opacity: 0.8;" title="视频通话"></i>
            <i class="fas fa-times chat-close" id="close-chat"></i>
        </div>
    </div>
    <div class="chat-body">
        <div id="video-container" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10; flex-direction: column;">
            <video id="remote-video" autoplay playsinline style="width: 100%; height: 100%; object-fit: cover;"></video>
            <video id="local-video" autoplay playsinline muted style="position: absolute; bottom: 10px; right: 10px; width: 30%; border: 1px solid #fff;"></video>
        </div>
        <div class="video-controls" style="display: none; position: absolute; bottom: 10px; left: 10px; gap: 10px;">
            <button id="hangup-video" style="background: rgba(255, 0, 0, 0.7); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer;">挂断</button>
        </div>
        <div id="user-list-sidebar">
            <div class="user-item active" data-type="lobby">公共大厅</div>
            <div id="online-users-container"></div>
        </div>
        <div id="chat-messages">
            <div class="message-bubble received">你好！欢迎来到 ACG 聊天室~</div>
        </div>
    </div>
    <div class="chat-input-area">
        <input type="text" id="chat-widget-input" placeholder="说点什么..." autocomplete="off">
        <button id="chat-widget-send"><i class="fas fa-paper-plane"></i></button>
    </div>

    <div id="custom-alert">
        <div class="alert-content">
            <div class="alert-text" id="alert-msg">请先登录后再发言</div>
            <div>
                <button class="alert-btn btn-login" onclick="window.location.href='/auth/login/'">去登录</button>
                <button class="alert-btn btn-cancel" onclick="document.getElementById('custom-alert').style.display='none'">再看看</button>
            </div>
        </div>
    </div>
</div>

<!-- Incoming Call Modal -->
<div id="incoming-call-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center;">
    <div style="background: white; padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 300px;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333;">视频通话请求</div>
        <div id="incoming-call-text" style="margin-bottom: 20px; color: #666;">有人邀请你视频通话</div>
        <div style="display: flex; justify-content: space-around;">
            <button id="btn-accept-call" style="background: #4cd137; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer;">接听</button>
            <button id="btn-reject-call" style="background: #ff6b81; color: white; border: none; padding: 8px 20px; border-radius: 20px; cursor: pointer;">拒绝</button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const fab = document.getElementById('chat-fab');
        const chatWindow = document.getElementById('chat-window');
        const closeBtn = document.getElementById('close-chat');
        const toggleUsersBtn = document.getElementById('toggle-users');
        const sidebar = document.getElementById('user-list-sidebar');
        const onlineUsersContainer = document.getElementById('online-users-container');
        const chatTitle = document.getElementById('chat-title');
        const msgInput = document.getElementById('chat-widget-input');
        const sendBtn = document.getElementById('chat-widget-send');
        const msgContainer = document.getElementById('chat-messages');

        // --- WebRTC Variables ---
        const videoContainer = document.getElementById('video-container');
        const videoControls = document.querySelector('.video-controls');
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const startVideoBtn = document.getElementById('start-video-call');
        const hangupBtn = document.getElementById('hangup-video');

        // Incoming Call Modal Elements
        const incomingCallModal = document.getElementById('incoming-call-modal');
        const incomingCallText = document.getElementById('incoming-call-text');
        const btnAcceptCall = document.getElementById('btn-accept-call');
        const btnRejectCall = document.getElementById('btn-reject-call');

        let chatSocket = null;
        let currentRoom = 'lobby';
        const myId = "{{ user.id }}";
        const myUsername = "{{ user.username }}";

        let localStream;
        let peerConnection;
        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' }
            ]
        };

        // --- UI Logic ---
        fab.addEventListener('click', () => {
            try {
                chatWindow.style.display = 'flex';
                
                // Position Safety Check: Ensure window is on screen
                const rect = chatWindow.getBoundingClientRect();
                if (rect.top < 0 || rect.left < 0 || rect.bottom > window.innerHeight || rect.right > window.innerWidth) {
                    // Reset if off-screen or weird
                    chatWindow.style.top = 'auto';
                    chatWindow.style.left = 'auto';
                    chatWindow.style.bottom = '100px';
                    chatWindow.style.right = '30px';
                }

                // Hide FAB as requested
                fab.style.display = 'none'; 
                
                switchRoom('lobby', 'ACG 大厅');
                loadUserList();
            } catch (e) {
                console.error("Error opening chat:", e);
                // Recovery: Show button if error
                fab.style.display = 'flex';
                alert("聊天窗口打开失败，请刷新页面。");
            }
        });

        closeBtn.addEventListener('click', () => {
            chatWindow.style.display = 'none';
            fab.style.display = 'flex'; // Show FAB again
        });

        toggleUsersBtn.addEventListener('click', () => {
            sidebar.style.display = sidebar.style.display === 'flex' ? 'none' : 'flex';
        });

        async function loadUserList() {
            try {
                const response = await fetch('/auth/api/users/');
                const users = await response.json();
                onlineUsersContainer.innerHTML = '';
                users.forEach(user => {
                    const div = document.createElement('div');
                    div.className = 'user-item';
                    div.textContent = user.username;
                    div.onclick = () => {
                        const roomName = `private_${Math.min(myId, user.id)}_${Math.max(myId, user.id)}`;
                        switchRoom(roomName, `与 ${user.username} 私聊`);
                        document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
                        div.classList.add('active');
                    };
                    onlineUsersContainer.appendChild(div);
                });
            } catch (e) { console.error("Failed to load users", e); }
        }

        document.querySelector('[data-type="lobby"]').onclick = function() {
            switchRoom('lobby', 'ACG 大厅');
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('active'));
            this.classList.add('active');
        };

        // --- Core Logic ---
        function switchRoom(roomName, title) {
            if (currentRoom === roomName && chatSocket) return;
            if (chatSocket) { chatSocket.close(); }
            currentRoom = roomName;
            chatTitle.textContent = title;
            msgContainer.innerHTML = '';
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const url = protocol + window.location.host + '/ws/chat/' + roomName + '/';
            chatSocket = new WebSocket(url);

            chatSocket.onmessage = async function(e) {
                const data = JSON.parse(e.data);
                if (data.type === 'error') {
                    document.getElementById('alert-msg').textContent = data.message;
                    document.getElementById('custom-alert').style.display = 'flex';
                } else if (data.type === 'chat_message' || (!data.type && data.message)) {
                    addMessage(data.message, data.sender === myUsername ? 'sent' : 'received', data.sender);
                } else if (data.type === 'call_notification') {
                    incomingCallText.textContent = `${data.sender} 邀请你进行视频通话`;
                    incomingCallModal.style.display = 'flex';
                    btnAcceptCall.onclick = () => {
                        incomingCallModal.style.display = 'none';
                        fab.click();
                        switchRoom(data.room_name, `与 ${data.sender} 私聊`);
                        waitForSocketConnection(chatSocket, function(){ sendSignal('ready_for_call', {}); });
                    };
                    btnRejectCall.onclick = () => { incomingCallModal.style.display = 'none'; };
                } else if (data.type === 'ready_for_call') {
                     if (!peerConnection) { await startCall(false); }
                } else if (data.type === 'video_offer') {
                    await handleVideoOffer(data);
                } else if (data.type === 'video_answer') {
                    await handleVideoAnswer(data);
                } else if (data.type === 'new_ice_candidate') {
                    await handleNewICECandidate(data);
                }
            };
        }

        function waitForSocketConnection(socket, callback){
            setTimeout(function () {
                if (socket.readyState === 1) { if (callback != null){ callback(); } }
                else { waitForSocketConnection(socket, callback); }
            }, 5);
        }

        // --- Video Call Functions ---
        startVideoBtn.onclick = async () => {
            if (currentRoom === 'lobby') { alert("请选择一个用户进行私聊后再发起视频通话"); return; }
            const parts = currentRoom.split('_');
            if (parts.length !== 3) return;
            const targetId = (parts[1] === myId) ? parts[2] : parts[1];
            chatSocket.send(JSON.stringify({ 'type': 'call_request', 'target_user_id': targetId }));
            alert("已发送视频通话请求，请等待对方接受...");
            videoContainer.style.display = 'flex';
            videoControls.style.display = 'flex';
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (e) { console.error(e); }
        };

        hangupBtn.onclick = hangup;

        async function startCall(sendRequest = true) {
            videoContainer.style.display = 'flex';
            videoControls.style.display = 'flex';
            chatWindow.classList.add('video-mode'); // Enter Video Mode
            // Center Window
            chatWindow.style.width = '900px';
            chatWindow.style.height = '600px';
            chatWindow.style.left = Math.max(0, (window.innerWidth - 900) / 2) + 'px';
            chatWindow.style.top = Math.max(0, (window.innerHeight - 600) / 2) + 'px';
            chatWindow.style.bottom = 'auto';
            chatWindow.style.right = 'auto';

            try {
                if (!localStream) {
                    localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                    localVideo.srcObject = localStream;
                }
                createPeerConnection();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                const offer = await peerConnection.createOffer();
                await peerConnection.setLocalDescription(offer);
                sendSignal('video_offer', { sdp: peerConnection.localDescription });
            } catch (e) { console.error(e); alert("无法访问摄像头/麦克风"); hangup(); }
        }

        async function handleVideoOffer(data) {
            if (peerConnection) return;
            // Auto-accept offer since we already confirmed via notification modal
            console.log("Auto-accepting video offer from", data.sender);
            
            videoContainer.style.display = 'flex';
            videoControls.style.display = 'flex';
            chatWindow.classList.add('video-mode'); // Enter Video Mode
            // Center Window
            chatWindow.style.width = '900px';
            chatWindow.style.height = '600px';
            chatWindow.style.left = Math.max(0, (window.innerWidth - 900) / 2) + 'px';
            chatWindow.style.top = Math.max(0, (window.innerHeight - 600) / 2) + 'px';
            chatWindow.style.bottom = 'auto';
            chatWindow.style.right = 'auto';

            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                createPeerConnection();
                localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
                await peerConnection.setRemoteDescription(new RTCSessionDescription(data.data.sdp));
                const answer = await peerConnection.createAnswer();
                await peerConnection.setLocalDescription(answer);
                sendSignal('video_answer', { sdp: peerConnection.localDescription });
            } catch (e) {
                console.error(e);
                hangup();
            }
        }

        async function handleVideoAnswer(data) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(data.data.sdp));
        }

        async function handleNewICECandidate(data) {
            try { if (peerConnection) await peerConnection.addIceCandidate(new RTCIceCandidate(data.data.candidate)); }
            catch (e) { console.error(e); }
        }

        function createPeerConnection() {
            peerConnection = new RTCPeerConnection(rtcConfig);
            peerConnection.onicecandidate = (e) => { if (e.candidate) sendSignal('new_ice_candidate', { candidate: e.candidate }); };
            peerConnection.ontrack = (e) => { remoteVideo.srcObject = e.streams[0]; };
            peerConnection.onconnectionstatechange = () => { if (peerConnection.connectionState === 'disconnected') hangup(); };
        }

        function sendSignal(type, data) { chatSocket.send(JSON.stringify({ type: type, data: data })); }

        function hangup() {
            if (peerConnection) { peerConnection.close(); peerConnection = null; }
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            localVideo.srcObject = null; remoteVideo.srcObject = null;
            videoContainer.style.display = 'none';
            videoControls.style.display = 'none';
            chatWindow.classList.remove('video-mode'); // Exit Video Mode
            // Reset Size and position safely
            chatWindow.style.width = '350px';
            chatWindow.style.height = '450px';
            // Optional: reset to corner or keep current pos
            chatWindow.style.top = 'auto';
            chatWindow.style.left = 'auto';
            chatWindow.style.bottom = '100px';
            chatWindow.style.right = '30px';
        }

        function sendMessage() {
            const message = msgInput.value.trim();
            if (message && chatSocket) { chatSocket.send(JSON.stringify({'message': message})); msgInput.value = ''; }
        }

        sendBtn.addEventListener('click', sendMessage);
        msgInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendMessage(); });

        function addMessage(text, type, senderName) {
            const div = document.createElement('div');
            div.className = `message-bubble ${type}`;
            if (type === 'received' && currentRoom === 'lobby') {
                const nameDiv = document.createElement('div');
                nameDiv.style.fontSize = '10px'; nameDiv.style.color = '#ff9a9e';
                nameDiv.style.marginBottom = '2px'; nameDiv.textContent = senderName;
                div.appendChild(nameDiv);
            }
            const textNode = document.createTextNode(text);
            div.appendChild(textNode);
            msgContainer.appendChild(div);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }

        // Draggable
        function makeDraggable(element, handle) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const dragHandle = handle || element;
            dragHandle.onmousedown = (e) => {
                if (e.target.closest('.chat-close') || e.target.closest('#toggle-users')) return;
                e.preventDefault();
                pos3 = e.clientX; pos4 = e.clientY;
                document.onmouseup = () => { document.onmouseup = null; document.onmousemove = null; };
                document.onmousemove = (e) => {
                    e.preventDefault();
                    pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY;
                    pos3 = e.clientX; pos4 = e.clientY;
                    
                    let newTop = element.offsetTop - pos2;
                    let newLeft = element.offsetLeft - pos1;
                    
                    // Boundary Checks
                    const minTop = 0;
                    const maxTop = window.innerHeight - element.offsetHeight;
                    const minLeft = 0;
                    const maxLeft = window.innerWidth - element.offsetWidth;
                    
                    if (newTop < minTop) newTop = minTop;
                    if (newTop > maxTop) newTop = maxTop;
                    if (newLeft < minLeft) newLeft = minLeft;
                    if (newLeft > maxLeft) newLeft = maxLeft;

                    element.style.bottom = 'auto'; element.style.right = 'auto';
                    element.style.top = newTop + "px";
                    element.style.left = newLeft + "px";
                };
            };
        }
        makeDraggable(fab);
        makeDraggable(chatWindow, document.querySelector('.chat-header'));
        
        // Ensure default position is set in JS to prevent initial glitch
        chatWindow.style.bottom = '100px';
        chatWindow.style.right = '30px';
        
        // Auto-connect on load
        switchRoom('lobby', 'ACG 大厅');

        // --- Global API for other pages ---
        window.openPrivateChat = function(targetUserId, targetUsername) {
            // Ensure chat window is open
            chatWindow.style.display = 'flex';
            // Reset position if weird
            const rect = chatWindow.getBoundingClientRect();
            if (rect.height === 0) {
                 chatWindow.style.top = 'auto'; 
                 chatWindow.style.left = 'auto';
                 chatWindow.style.bottom = '100px';
                 chatWindow.style.right = '30px';
            }
            fab.style.display = 'none';
            
            // Switch room logic
            const roomName = `private_${Math.min(myId, targetUserId)}_${Math.max(myId, targetUserId)}`;
            switchRoom(roomName, `与 ${targetUsername} 私聊`);
        };
    });
</script>